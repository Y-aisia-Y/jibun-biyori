services:
  - type: web
    name: jibun-biyori
    env: ruby
    region: singapore
    plan: free
    buildCommand: |
      bundle install
      yarn install
      bundle exec rails assets:precompile
    startCommand: |
      echo "=== MIGRATION FORCE EXECUTION START ==="
      echo "Current environment: $RAILS_ENV"
      echo "Database URL check: $(test -n "$DATABASE_URL" && echo 'EXISTS' || echo 'MISSING')"
      echo "=== Migration files verification ==="
      ls -la db/migrate/
      echo "=== Force database operations ==="
      bundle exec rails db:drop || echo "Drop failed or no database"
      bundle exec rails db:create || echo "Create failed"
      echo "=== CRITICAL: Execute migrations ==="
      bundle exec rails db:migrate || echo "Migration failed"
      echo "=== Verify users table creation ==="
      bundle exec rails runner "
        begin
          puts '=== Database Tables Check ==='
          tables = ActiveRecord::Base.connection.tables
          puts 'All tables: ' + tables.inspect
          if tables.include?('users')
            puts '✅ SUCCESS: users table EXISTS!'
            puts 'Users table columns: ' + User.column_names.inspect
            puts 'Current users count: ' + User.count.to_s
          else
            puts '❌ CRITICAL ERROR: users table NOT FOUND'
            puts 'Available tables: ' + tables.inspect
          end
        rescue => e
          puts '❌ Database connection error: ' + e.message
        end
      " || echo "Verification failed"
      echo "=== Starting Rails application ==="
      bundle exec puma -C config/puma.rb
    envVars:
      - key: RAILS_ENV
        value: production
      - key: SECRET_KEY_BASE
        generateValue: true
      - key: RAILS_MASTER_KEY
        sync: false
      - key: RAILS_SERVE_STATIC_FILES
        value: true
      - key: DATABASE_URL
        fromDatabase:
          name: jibun-biyori-db
          property: connectionString

databases:
  - name: jibun-biyori-db
    databaseName: jibun_biyori_production
    user: jibun_biyori_db_user
    plan: basic-256mb
    region: singapore