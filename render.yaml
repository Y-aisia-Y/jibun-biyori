services:
  - type: web
    name: jibun-biyori
    env: ruby
    region: singapore
    plan: free
    buildCommand: |
      bundle install
      yarn install
      bundle exec rails assets:precompile
    startCommand: |
      echo "=== Environment Check ==="
      echo "RAILS_ENV: $RAILS_ENV"
      echo "Ruby version: $(ruby -v)"
      echo "Rails version: $(bundle exec rails -v)"
      echo "=== Migration Files Check ==="
      ls -la db/migrate/
      echo "=== Database URL Check ==="
      echo "DATABASE_URL exists: $(test -n "$DATABASE_URL" && echo 'YES' || echo 'NO')"
      echo "=== Force Database Reset ==="
      bundle exec rails db:drop || echo "No database to drop"
      bundle exec rails db:create || echo "Database creation failed"
      echo "=== Execute Migrations ==="
      bundle exec rails db:migrate || echo "Migration execution failed"
      echo "=== Verify Migration Results ==="
      bundle exec rails runner "
        begin
          puts '=== Available Tables ==='
          tables = ActiveRecord::Base.connection.tables
          puts tables.inspect
          puts '=== Users Table Check ==='
          if tables.include?('users')
            puts 'SUCCESS: users table exists!'
            puts 'Users table columns: ' + User.column_names.inspect
            puts 'Users count: ' + User.count.to_s
          else
            puts 'ERROR: users table not found'
          end
        rescue => e
          puts 'ERROR in verification: ' + e.message
        end
      " || echo "Verification script failed"
      echo "=== Starting Application ==="
      bundle exec puma -C config/puma.rb
    envVars:
      - key: RAILS_ENV
        value: production
      - key: SECRET_KEY_BASE
        generateValue: true
      - key: RAILS_MASTER_KEY
        sync: false
      - key: RAILS_SERVE_STATIC_FILES
        value: true
      - key: DATABASE_URL
        fromDatabase:
          name: jibun-biyori-db
          property: connectionString

databases:
  - name: jibun-biyori-db
    databaseName: jibun_biyori_production
    user: jibun_biyori_db_user
    plan: Basic-256mb
    region: singapore